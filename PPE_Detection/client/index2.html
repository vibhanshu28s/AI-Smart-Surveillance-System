<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PPE Smart Surveillance</title>
</head>
<body>
  <h2>Live PPE Feed</h2>
  <video id="video" autoplay playsinline muted style="width: 100%; max-width: 800px; background: black;"></video>

  <script>
 const pc = new RTCPeerConnection();
const videoElement = document.getElementById("video");

// Prepare for incoming video
pc.addTransceiver("video", { direction: "recvonly" });

pc.ontrack = (event) => {
    console.log("Track received");
    // Attach the first stream from the event
    if (event.streams && event.streams[0]) {
        videoElement.srcObject = event.streams[0];
    } else {
        // Fallback for browsers that don't provide the stream in the event
        videoElement.srcObject = new MediaStream([event.track]);
    }

    // Explicitly call play to handle Chrome rendering "nudges"
    videoElement.play().catch(e => console.error("Autoplay blocked:", e));
};

async function start() {
    console.log("Starting WebRTC Negotiation");
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const response = await fetch("/offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type
        })
    });

    const answer = await response.json();
    await pc.setRemoteDescription(new RTCSessionDescription(answer));
}

// Optional: call start() on a button click for 100% Chrome compatibility
// document.getElementById('startButton').onclick = () => start();
start();
</script>

</body>
</html>
